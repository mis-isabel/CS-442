/*Isabel Sutedjo
20006618
I pledge my honor that I have abided by the Stevens Honor System.
Query 1*/

WITH AGG AS
	(SELECT CUST,
			MIN(QUANT) AS MIN_Q,
			MAX(QUANT) AS MAX_Q,
			AVG(QUANT) AS AVG_Q
		FROM SALES
		GROUP BY CUST),
	MIN_DETAIL AS
	(SELECT AGG.CUST,
			AGG.MIN_Q,
			S.PROD AS MIN_PROD,
			S.DATE AS MIN_DATE,
			S.STATE AS MIN_STATE,
			AGG.MAX_Q,
			AGG.AVG_Q
		FROM AGG
		INNER JOIN SALES S ON AGG.CUST = S.CUST
		AND AGG.MIN_Q = S.QUANT),
	MAX_DETAIL AS
	(SELECT AGG.CUST,
			AGG.MAX_Q,
			S.PROD AS MAX_PROD,
			S.DATE AS MAX_DATE,
			S.STATE AS MAX_STATE,
			AGG.MIN_Q,
			AGG.AVG_Q
		FROM AGG
		INNER JOIN SALES S ON AGG.CUST = S.CUST
		AND AGG.MAX_Q = S.QUANT)
SELECT MD.CUST AS CUSTOMER,
	MD.MIN_Q,
	MD.MIN_PROD,
	MD.MIN_DATE,
	MD.MIN_STATE AS MIN_STATE,
	MD.MAX_Q,
	MXD.MAX_PROD,
	MXD.MAX_DATE,
	MXD.MAX_STATE AS MAX_STATE,
	MXD.AVG_Q
FROM MIN_DETAIL AS MD
INNER JOIN MAX_DETAIL AS MXD ON MD.CUST = MXD.CUST

--Query 2
WITH T1 AS
	(SELECT MONTH,
			DAY,
			SUM(QUANT) AS TOTAL_Q
		FROM SALES
		GROUP BY MONTH,
			DAY),
	MPD AS
	(SELECT MONTH,
			MAX(TOTAL_Q) AS MOST_PROFIT_TOTAL_Q
		FROM T1
		GROUP BY MONTH),
	MPT AS
	(SELECT T1.MONTH,
			DAY AS MOST_PROFIT_DAY,
			MOST_PROFIT_TOTAL_Q
		FROM T1,
			MPD
		WHERE T1.MONTH = MPD.MONTH
			AND T1.TOTAL_Q = MPD.MOST_PROFIT_TOTAL_Q ),
	LPD AS
	(SELECT MONTH,
			MIN(TOTAL_Q) AS LEAST_PROFIT_TOTAL_Q
		FROM T1
		GROUP BY MONTH),
	LPT AS
	(SELECT T1.MONTH,
			DAY AS LEAST_PROFIT_DAY,
			LEAST_PROFIT_TOTAL_Q
		FROM T1,
			LPD
		WHERE T1.MONTH = LPD.MONTH
			AND T1.TOTAL_Q = LPD.LEAST_PROFIT_TOTAL_Q )
SELECT *
FROM MPT
NATURAL JOIN LPT

--Query 3
WITH T1 AS (
    SELECT MONTH, PROD, SUM(QUANT) AS TOTAL_Q
    FROM SALES
    GROUP BY MONTH, PROD
),
MAX_MON AS (
    SELECT T1.PROD, MONTH AS MOST_FAV_MO
    FROM T1
    JOIN (
        SELECT PROD, MAX(TOTAL_Q) AS MAX_Q
        FROM T1
        GROUP BY PROD
    ) AS Q
    ON T1.PROD = Q.PROD AND Q.MAX_Q = T1.TOTAL_Q
),
MIN_MON AS (
    SELECT T1.PROD, MONTH AS LEAST_FAV_MO
    FROM T1
    JOIN (
        SELECT PROD, MIN(TOTAL_Q) AS MIN_Q
        FROM T1
        GROUP BY PROD
    ) AS Q
    ON T1.PROD = Q.PROD AND Q.MIN_Q = T1.TOTAL_Q
)
SELECT PROD AS PRODUCT, MOST_FAV_MO, LEAST_FAV_MO
FROM MAX_MON
NATURAL JOIN MIN_MON;

--Query 4
WITH T1 AS
	(SELECT CUST CUSTOMER,
			PROD PRODUCT,
			AVG(QUANT) T1_AVG
		FROM SALES
		WHERE MONTH = 1
			OR MONTH = 2
			OR MONTH = 3
		GROUP BY CUST,
			PROD),
	T2 AS
	(SELECT CUST,
			PROD,
			AVG(QUANT) T2_AVG
		FROM SALES
		WHERE MONTH = 4
			OR MONTH = 5
			OR MONTH = 6
		GROUP BY CUST,
			PROD),
	T3 AS
	(SELECT CUST,
			PROD,
			AVG(QUANT) T3_AVG
		FROM SALES
		WHERE MONTH = 7
			OR MONTH = 8
			OR MONTH = 9
		GROUP BY CUST,
			PROD),
	T4 AS
	(SELECT CUST,
			PROD,
			AVG(QUANT) T4_AVG
		FROM SALES
		WHERE MONTH = 10
			OR MONTH = 11
			OR MONTH = 12
		GROUP BY CUST,
			PROD),
	T5 AS
	(SELECT T1.CUSTOMER,
			T1.PRODUCT,
			T1.T1_AVG,
			T2.T2_AVG,
			T3.T3_AVG,
			T4.T4_AVG
		FROM T1
		INNER JOIN T2 ON T1.CUSTOMER = T2.CUST
		AND T1.PRODUCT = T2.PROD
		INNER JOIN T3 ON T2.CUST = T3.CUST
		AND T2.PROD = T3.PROD
		INNER JOIN T4 ON T3.CUST = T4.CUST
		AND T3.PROD = T4.PROD),
	T6 AS
	(SELECT T5.CUSTOMER,
			T5.PRODUCT,
			T5.T1_AVG,
			T5.T2_AVG,
			T5.T3_AVG,
			T5.T4_AVG,
			AVG(S.QUANT) AS AVERAGE,
			SUM(S.QUANT) AS TOTAL,
			COUNT(S.QUANT) AS COUNT
		FROM T5
		INNER JOIN SALES S ON T5.CUSTOMER = S.CUST
		AND T5.PRODUCT = S.PROD
		GROUP BY T5.CUSTOMER,
			T5.PRODUCT,
			T5.T1_AVG,
			T5.T2_AVG,
			T5.T3_AVG,
			T5.T4_AVG)
SELECT *
FROM T6;

--Query 5
WITH T1 AS
	(SELECT CUST,
			PROD,
			MAX(QUANT) AS NJ_MAX
		FROM SALES
		WHERE STATE = 'NJ'
		GROUP BY CUST,
			PROD),
	T2 AS
	(SELECT T1.CUST,
			T1.PROD,
			NJ_MAX,
			S.DATE AS DATE1
		FROM T1
		INNER JOIN SALES AS S ON T1.CUST = S.CUST
		AND T1.PROD = S.PROD
		AND S.QUANT = NJ_MAX
		AND STATE = 'NJ'),
	T3 AS
	(SELECT CUST,
			PROD,
			MAX(QUANT) AS NY_MAX
		FROM SALES
		WHERE STATE = 'NY'
		GROUP BY CUST,
			PROD),
	T4 AS
	(SELECT T3.CUST,
			T3.PROD,
			NY_MAX,
			S.DATE AS DATE2
		FROM T3
		INNER JOIN SALES AS S ON T3.CUST = S.CUST
		AND T3.PROD = S.PROD
		AND S.QUANT = NY_MAX
		AND STATE = 'NY'),
	T5 AS
	(SELECT CUST,
			PROD,
			MAX(QUANT) AS CT_MAX
		FROM SALES
		WHERE STATE = 'CT'
		GROUP BY CUST,
			PROD),
	T6 AS
	(SELECT T5.CUST,
			T5.PROD,
			CT_MAX,
			S.DATE AS DATE3
		FROM T5
		INNER JOIN SALES AS S ON T5.CUST = S.CUST
		AND T5.PROD = S.PROD
		AND S.QUANT = CT_MAX
		AND STATE = 'CT')
SELECT T2.CUST AS CUSTOMER,
	T2.PROD AS PRODUCT,
	T2.NJ_MAX,
	T2.DATE1 AS DATE,
	T4.NY_MAX,
	T4.DATE2 AS DATE,
	T6.CT_MAX,
	T6.DATE3 AS DATE
FROM T2
INNER JOIN T4 ON T2.CUST = T4.CUST
AND T2.PROD = T4.PROD
INNER JOIN T6 ON T2.CUST = T6.CUST
AND T2.PROD = T6.PROD
WHERE T4.NY_MAX > T2.NJ_MAX
	OR T4.NY_MAX > T6.CT_MAX
ORDER BY CUSTOMER